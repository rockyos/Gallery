@model CoreTest.ViewModels.Photos.IndexViewModel;

@{
    ViewData["Title"] = "Index";
}

<table class="table table-borderless" id="table" data-toggle="table" data-response-handler="responseHandler" data-url="Photos/GetListfromDB">    @*data-ajax="ajaxRequest"*@
    <thead>
        <tr>
            <th data-field="ImageContent"></th>
            <th data-field="PhotoName"></th>
            <th data-field="DelButton"></th>
        </tr>
    </thead>
</table>



<form id="post_file_form" enctype="multipart/form-data" method="post">
    <div class="d-flex justify-content-center">
        <div class="btn sendbtn btn-outline-info">
            <span class="font-weight-bold">Select image</span>
            <input asp-for="FormFile" type="file" accept="image/*" name="FormFile" />
            <span asp-validation-for="FormFile" class="text-danger font-weight-bold"></span>
        </div>
    </div>
    <hr />
    <div class="d-flex justify-content-end">
        <div class="btn-group" role="group">
        <input type="reset" id="btn_reset" value="Cancel" class="btn btn-outline-dark btn-sm font-weight-bold" />
        <button id="savebutton" class="btn btn-outline-success font-weight-bold">
            Save<img id="loaderimg" src="~/images/loaderimg.gif" />
        </button>
        </div>
    </div>
</form>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

<script>
    $(document).ready(function () {
        $('#loaderimg').hide();
        $(document).on("click", ".btndelete", function () {
            var id = $(this).attr('id');
            $.ajax({
                url: 'Photos/Delete',
                type: 'POST',
                data: { id: id },
                success: function (data) {
                },
                error: function (data) {
                    alert('Error');
                }
            });
        });
    });

    function responseHandler(json) { // load all photos from DB
        return parseJsonHTML(json);
    }

    function parseJsonHTML(json) { // parse json to javascript data & HTML
        var jsdata = JSON.parse(json);
        $(jsdata).each(function (index) {
            jsdata[index].ImageContent = '<img class="img-thumbnail mx-auto d-block" src="' + '/Photos/ImageResize/' + jsdata[index].Id + '?width=320" alt="Foto" />';
            Object.assign(jsdata[index], { DelButton: '<button id="' + jsdata[index].Id + '" class="btndelete btn btn-outline-danger font-weight-bold">Delete</button>' });
        });
        return jsdata;
    }

    $(document).on('submit', '#post_file_form', function (event) {
        event.preventDefault();
        $('#loaderimg').show();
        var formdata = new FormData();
        formdata.append('FormFile', $('#post_file_form').find('#FormFile').get(0).files[0]);
        $.ajax({
           type: 'POST',
           url: 'Photos/Index',
           data: formdata,
           processData: false,
           contentType: false,
           success: function (result) {
               $('#loaderimg').hide();
               var res = parseJsonHTML(result)
               $('#table').bootstrapTable('append', res);
           },
           error: function (error) {
              $('#loaderimg').hide();
           }
        });
    });
</script>
}


